@page "/app/products/manage"
@using System.IO
@rendermode InteractiveServer
@attribute [Authorize(Policy ="AdministrationPolicy")]

<PageTitle>Products</PageTitle>
<TwoSectionsTemplate>
	<Col12Template>
		<AdminHomeHeader />
        <NetcodeHubBreadCrumb BreadCrumbs="BreadCrumbs" DeactivatedColor="@BreadCrumbColor.Primary()" BackgroundColor="@BreadCrumbBackgroundColor.SecondarySubtle()" ></NetcodeHubBreadCrumb>
	    <div class="row bg-primary py-2 mt-3" style="border-radius:20px" >
            <div class="col-lg-12 col-sm-12 col-md-12">
                <div class="card border-1 shadow-lg" style="border-radius:20px" >
                    <div class="card-header">
                        <button class="btn btn-outline-primary float-end" @onclick="CreateProductBtnClicked" >
                            <i class="mdi mdi-plus"></i> Create Product
                        </button>
                    </div>
                    <div class="card-body border-1 border-primary">
                        <div class="mb-5" >
                            <input type="search" class="form-control float-end w-25 mb-2 p-2 border-secondary" Placeholder="Search name, desc, serial no." @onchange="SearchProduct">
                            </input>
                        </div>
                        @if (PermanentProducts != null && PermanentProducts.Any())
                        {
                            <SfGrid DataSource="@PermanentProducts" AllowPaging="true" AllowSorting="true" AllowExcelExport="true" style="margin-top:35px"
                            AllowGrouping="true" AllowPdfExport="true" Toolbar="ToolbarItems" AllowResizing="true" @ref="DefaultGrid">
                                <GridPageSettings PageSize="5"></GridPageSettings>
                                <GridSelectionSettings Type="SelectionType.Single" Mode="Syncfusion.Blazor.Grids.SelectionMode.Both"></GridSelectionSettings>
                                <GridEvents OnToolbarClick="ToolbarClickHandler" TValue="GetProductResponseDTO" RowSelected="RowSelectHandler"></GridEvents>
                                <GridColumns>
                                    <GridColumn HeaderText="Image" AllowFiltering="false">
                                        <Template>
                                            @{
                                                var product = (context as GetProductResponseDTO);
                                                <div class="image">
                                                    <img src="@(product!.Base64Image)" alt="@product.Name" width="70" height="50" />
                                                </div>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.DateAdded) HeaderText="Date" Format="d" Type="ColumnType.Date"></GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.Id) HeaderText="ID"></GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.Name) HeaderText="Name"></GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.SerialNumber) HeaderText="Serial No"></GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.Price) HeaderText="Price" Format="C2" Type="ColumnType.Decimal"></GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.Quantity) HeaderText="Quantity" Type="ColumnType.Integer"></GridColumn>
                                    <GridColumn HeaderText="Category" AllowFiltering="false">
                                        <Template>
                                            @{
                                                var product = (context as GetProductResponseDTO);
                                                <p>@(product!.Category.Name)</p>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn HeaderText="Location" AllowFiltering="false">
                                        <Template>
                                            @{
                                                var product = (context as GetProductResponseDTO);
                                                <p>@(product!.Location.Name)</p>
                                            }
                                        </Template>
                                    </GridColumn>
                                    <GridColumn Field=@nameof(GetProductResponseDTO.Description) HeaderText="Description"></GridColumn>
                                </GridColumns>

                            </SfGrid>
                        }
                        else
                        {
                            <p>Loading or no products found...</p>
                        }

                    </div>
                </div>
            </div>
        </div>

        <Modal @bind-Open="IsOpen" BootstrapClass="border-primary rounded p-2 ml-2" CustomStyle="@ModalCustomStyle" >
            <ContentContent>
                @if(ShowProductPage)
                {
                    <div  class="card border-1 shadow-sm">
                        <div class="card-header">
                            <i class="mdi mdi-folder-plus text-primary fs-4 px-3 menu-icon text-start"></i>
                            <span class="text-center text-primary fw-bold">@ModalTitle</span>
                            <i class="mdi mdi-close text-primary fw-bold float-end fs-4 menu-icon cursorStyle" @onclick="CloseModal"></i>
                        </div>
                        <div class="card-body">
                            <EditForm Model="ProductModel" OnValidSubmit="SaveProduct" Enhance >
                                <DataAnnotationsValidator />
                                <div class="form-group mt-3">
                                    <FloatingText Label="Product Name" @bind-Value="ProductModel.Name" class="form-control" />
                                </div>
                                <div class="form-group mt-3">
                                    <FloatingText Label="Serial Number" @bind-Value="ProductModel.SerialNumber" class="form-control" />
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form=label">Product Price</label>
                                    <InputNumber @bind-Value="ProductModel.Price" class="form-control" />
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form=label">Product Quantity</label>
                                    <FloatingNumber Label="Product Quantity" @bind-Value="ProductModel.Quantity" class="form-control" />
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form=label">Description</label>
                                    <FloatingTextArea Label="Product Description" @bind-Value="ProductModel.Description" class="form-control" />
                                </div>
                                <div class="form-group">
                                    <NetcodeHubFileUpload @ref="FileUploadComponent" Notify="RetrieveContent" RequiredExtensions="RequiredEx" />
                                </div>
                                <div class="form-group mt-0">
                                    <label class="form-label">Select Category</label>
                                    <select class="form-select mb-3" @onchange="CategorySelectionChanged" >
                                        @if(Categories != null)
                                        {
                                            @if(SelectedProduct.Id == Guid.Empty)
                                            {
                                                <option value="@SelectedProduct.CategoryId">@SelectedProduct.Category.Name</option>
                                            }
                                            else
                                            {
                                                <option>Select Category</option>
                                            }

                                            foreach(var cat in Categories)
                                            {
                                                if(SelectedProduct.CategoryId != cat.Id)
                                                {
                                                    <option value="@cat.Id">@cat.Name</option>
                                                }
                                            }
                                        }
                                    </select>
                                </div>

                                <div class="form-group mt-0">
                                    <label class="form-label">Select Location</label>
                                    <select class="form-select mb-3" @onchange="LocationSelectionChanged">
                                        @if (Locations != null)
                                        {
                                            @if (SelectedProduct.Id == Guid.Empty)
                                            {
                                                <option value="@SelectedProduct.LocationId">@SelectedProduct.Location.Name</option>
                                            }
                                            else
                                            {
                                                <option>Select Location</option>
                                            }

                                            foreach (var loc in Locations)
                                            {
                                                if (SelectedProduct.LocationId != loc.Id)
                                                {
                                                    <option value="@loc.Id">@loc.Name</option>
                                                }
                                            }
                                        }
                                    </select>
                                </div>
                                <div class="form-group mt-3">
                                    @if(Loading)
                                    {
                                        <GenericSpinnerButton Text="Saving Product..." ButtonClass="btn btn-primary" />
                                    }
                                    else
                                    {
                                        @if(ProductModel.Base64Image != null)
                                        {
                                            <img width="50" height="50" style="border-radius:100%" src="@ProductModel.Base64Image" class="float-start" />
                                        }
                                    }
                                    <button type="submit" class="btn btn-primary float-end" >Save Product</button>
                                </div>
                                <div class="form-group mt-2">
                                    @if(Errors != "")
                                    {
                                        @Errors
                                    }
                                    else
                                    {
                                        <ValidationSummary />
                                    }
                                </div>

                            </EditForm>
                        </div>
                    </div>
                }
                @if(ShowConfirmationPage)
                {
                    <div class="card">
                        <div class="card-header d-flex justify-content-between">
                            <i class="d-flex mdi mdi-delete-sweep text-danger fs-4 px-3 menu-icon text-start"></i>
                            <span class="text-center text-primary fw-bold">Confirm Product Delete</span>
                            <i class="d-flex mdi mdi-close text-danger fw-bold float-end fs-4 cursorStyle" @onclick="CloseModal"></i>
                        </div>
                        <div card-body>Are you sure you want to delete this product?</div>
                        <div class="card-footer">
                            @if (Loading)
                            {
                                <GenericSpinnerButton Text="Deleting..." ButtonClass="btn btn-danger" />
                            }
                            else
                            {
                                <button type="button" class="btn btn-danger float-end" @onclick="ConfirmDelete">
                                    <i class="mdi mdi-delete"></i>
                                    Comfirm
                                </button> 
                            }
                            <button type="submit" class="btn btn-primary float-end">Save Product</button>
                        </div>
                    </div>
                }
            </ContentContent>
        </Modal>

    </Col12Template>
    @*  <FooterTemplate><Footer /></FooterTemplate> *@
</TwoSectionsTemplate>
<NetcodeHubToast @ref="ToastComponent" />



@code {
    string ModalTitle = "New Product";
    private SfGrid<GetProductResponseDTO>? DefaultGrid;
    NetcodeHubToast? ToastComponent;
    string ModalCustomStyle = string.Empty;
    string Search = string.Empty;
    List<string> RequiredEx = [".jpg", "png"];
    NetcodeHubFileUpload? FileUploadComponent;
    string Errors = "";
    private bool ShowProductPage;
    private bool ShowConfirmationPage;
    private Dictionary<string, string> BreadCrumbs = new Dictionary<string, string>
	{
	  {"Home","app/home"},
	  {"Manage Products",null!}
	};
    private List<ItemModel> ToolbarItems = new List<ItemModel>();

    public bool Loading { get; set; } = false;
    public int Duration { get; set; }
    public bool IsOpen { get; set; }
    [CascadingParameter] public Task<AuthenticationState>? UserAuthState { get; set; }
    private IEnumerable<GetProductResponseDTO> Products { get; set; } = [];
    private IEnumerable<GetProductResponseDTO> PermanentProducts { get; set; } = [];
    private IEnumerable<GetCategoryResponseDTO> Categories { get; set; } = [];
    private IEnumerable<GetLocationResponseDTO> Locations { get; set; } = [];
    private AddProductRequestDTO ProductModel { get; set; } = new();
    ClaimsPrincipal? User;
    private HubConnection? hubConnection;
    bool CanDelete = false;

    protected async override Task OnInitializedAsync()
    {
        User = (await UserAuthState!).User;
        CanDelete = customAuthorizationService.CustomClaimChecker(User, DefaultClaims.Delete);
        homeGenericState.StateChanged += StateButtonClicked;

        await GetDefaults();
        LoadToolbarItems();        

        hubConnection = netcodeHubConnectionService.GetHubConnection();
        hubConnection.On<string>("Notify", async (clientId) =>
        {
            await CallWhenNotified();
        });
        if (hubConnection == null)
            await hubConnection!.StartAsync();
    }

    async Task CallWhenNotified()
    {
        await InvokeAsync(async () =>
        {
            StateHasChanged();
            await adminActiveOrderCountState.GetActiveOrdersCount();
        });
    }

    // Navigate to order pages when state buttons are clicked
    void StateButtonClicked()
    {
        string adminOrderUrl = "app/administration/products/orders";
        if (homeGenericState.IsAdmin)
            navManager.NavigateTo($"{adminOrderUrl}/{homeGenericState.StateName}");
    }

    private async Task GetDefaults()
    {
        await GetProducts();
       // PermanentProducts = Products;
        await GetCategories();
        await GetLocations();
    }

    // Get Categories
    async Task GetCategories()
    {
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new GetAllCategoriesQuery());
        Categories = result;
    }

    // Get Locations
    async Task GetLocations()
    {
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new GetAllLocationsQuery());
        Locations = result;
    }

    // Get Products
    async Task GetProducts()
    {
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new GetProductsQuery());
        Products = result;
        PermanentProducts = Products;
    }

    void LoadToolbarItems()
    {
        if(CanDelete)
        {
            ToolbarItems.Add(new ItemModel() { Text = "Delete", TooltipText = "Delete Product", PrefixIcon = "e-trash" });
        }
        ToolbarItems.Add(new ItemModel() { Text = "View", TooltipText = "View Product", PrefixIcon = "e-eye" });
        ToolbarItems.Add(new ItemModel() { Text = "Edit", TooltipText = "Edit Product", PrefixIcon = "e-edit" });
        ToolbarItems.Add(new ItemModel() { Text = "PDF", TooltipText = "Export to Pdf", PrefixIcon = "e-icons e-export-pdf" });
        ToolbarItems.Add(new ItemModel() { Text = "EXCEL", TooltipText = "Export to Excel", PrefixIcon = "e-icons e-export-xls" });
        ToolbarItems.Add(new ItemModel() { Text = "Print", TooltipText = "Print", PrefixIcon = "e-print" });
    }

    void OpenModal() => IsOpen = true;

    void CreateProductBtnClicked()
    {
        ModalTitle = "New Product";
        ResetModalDisplay();
        ModalCustomStyle = "position:relative; left:45vw; top:10vh; min-width:250px";
        //ModalCustomStyle = "position: fixed; top: 10vh; left: 30vw; z-index: 1050; background: white; width: 600px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5);";
        ShowProductPage = true;
        OpenModal();
    }

    void CloseModal()
    {
        ProductModel = new();
        IdHolder = Guid.Empty;
        IsOpen = false;
    }
    

    private Guid IdHolder { get; set; } = Guid.Empty;

    async Task SaveProduct()
    {
        Loading = true;
        await Task.Delay(3000);
        ServiceResponse response = new(false, null!);
        if(IdHolder != Guid.Empty)
        {
            var update = ProductModel.Adapt(new UpdateProductRequestDTO());
            update.Id = IdHolder;
            using var scope = serviceProvider.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
            response = await mediator.Send(new UpdateProductCommand(update));
            await accountService.SaveActivityAsync(new ActivityTrackerRequestDTO()
                {
                    UserId = User!.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)!.Value.ToString(),
                    Title = "Update Product method called",
                    Description = response.Message,
                    OperationState = response.Flag,
                    Date = DateTime.Now.Date
                });
            Loading = false;
            StateHasChanged();
        }
        else
        {
            using var scope = serviceProvider.CreateScope();
            var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
            response = await mediator.Send(new CreateProductCommand(ProductModel));
            await accountService.SaveActivityAsync(new ActivityTrackerRequestDTO()
                {
                    UserId = User!.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)!.Value.ToString(),
                    Title = "Create Product method called",
                    Description = response.Message,
                    OperationState = response.Flag,
                    Date = DateTime.Now.Date
                });
        }
        if(response.Flag)
        {
            CloseModal();
            await GetProducts();
            PermanentProducts = Products;
            await ToastComponent!.ShowSuccessToast("Info", response.Message);
            ProductModel = new();
            SelectedProduct = new();
        }
        else
        {
            await ToastComponent!.ShowErrorToast("Alert", response.Message);
        }
        Loading = false;
    }


    void RetrieveContent(FileModel? incomingFile)
    {
        if (incomingFile is null) return;
        foreach(var file in incomingFile!.IBrowserFiles!)
        {
            var getFileNameAndBase4 = incomingFile.BaseFiles!.FirstOrDefault(_ => _.Key.Equals(file.Name, StringComparison.OrdinalIgnoreCase));
            if (getFileNameAndBase4.Key != null)
                ProductModel.Base64Image = getFileNameAndBase4.Value;
        }
    }

    void CategorySelectionChanged(Microsoft.AspNetCore.Components.ChangeEventArgs e) => ProductModel.CategoryId = Guid.Parse(e.Value!.ToString()!);
    void LocationSelectionChanged(Microsoft.AspNetCore.Components.ChangeEventArgs e) => ProductModel.LocationId = Guid.Parse(e.Value!.ToString()!);

    async Task ToolbarClickHandler(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args.Item.Text.ToLower() == "excel")
            await this.DefaultGrid!.ExportToExcelAsync();

        else if (args.Item.Text.ToLower() == "pdf")
            await this.DefaultGrid!.ExportToPdfAsync();

        else if (args.Item.Text.ToLower() == "print")
            await this.DefaultGrid!.PrintAsync();

        else if (args.Item.Text.ToLower() == "view")
        {
            bool check = await CheckIfRowSelected();
            if (check)
                navManager.NavigateTo($"app/products/details/{SelectedProduct.Id.ToString()}");
        }

        else if (args.Item.Text.ToLower() == "add")
        {
            ProductModel = new();
            OpenModal();
        }

        else if (args.Item.Text.ToLower() == "edit")
        {
            bool check = await CheckIfRowSelected();
            if (check)
            {
                ResetModalDisplay();
                ModalCustomStyle = "position:relative; left:45vw; top:10vh; min-width:250px";
                ModalTitle = "Update Product";
                SelectedProduct.Adapt(ProductModel);
                IdHolder = SelectedProduct.Id;
                ShowProductPage = true;
                OpenModal();
            }

        }

        else if (args.Item.Text.ToLower() == "delete")
        {

            if (await CheckIfRowSelected())
            {
                ResetModalDisplay();
                ModalCustomStyle = "position:relative; left:40vw; top:45vh;";
                ModalTitle = "Update Product";                
                ShowConfirmationPage = true;
                OpenModal();
            }

        }                   
    }

    async Task ConfirmDelete()
    {
        Loading = true;
        await Task.Delay(3000);
        using var scope = serviceProvider.CreateScope();
        var mediator = scope.ServiceProvider.GetRequiredService<IMediator>();
        var result = await mediator.Send(new DeleteProductCommand(SelectedProduct.Id));
        await accountService.SaveActivityAsync(new ActivityTrackerRequestDTO()
        {
                UserId = User!.Claims.FirstOrDefault(c => c.Type == ClaimTypes.NameIdentifier)!.Value.ToString(),
                Title = "Delete Product method called",
                Description = result.Message,
                OperationState = result.Flag,
                Date = DateTime.Now.Date
        });
        if(result.Flag)
        {
            await GetProducts();
            PermanentProducts = Products;
            await ToastComponent!.ShowSuccessToast("Info", result.Message);
            SelectedProduct = new();
            CloseModal();
        }
        else
        {
            await ToastComponent!.ShowErrorToast("Alert", result.Message);
        }
        Loading = false;
    }

    async Task<bool> CheckIfRowSelected()
    {
        if(SelectedProduct.Id == Guid.Empty)
        {
            Duration = 2000;
            await ToastComponent!.ShowErrorToast("Alert", "No row selected");
            return false;
        }
        return true;
    }

    private GetProductResponseDTO SelectedProduct { get; set; } = new();

    public void RowSelectHandler(RowSelectEventArgs<GetProductResponseDTO> args) => SelectedProduct = args.Data;

    ////// <summary>
    /// SEARCH PRODUCT
    /// </summary>
    
    void SearchProduct(Microsoft.AspNetCore.Components.ChangeEventArgs e)
    {
        try
        {
            string trimFilter = e.Value!.ToString()!.Trim();

            PermanentProducts = Products
            .Where(x => x.Name.Contains(trimFilter, StringComparison.OrdinalIgnoreCase) ||
                x.SerialNumber.Contains(trimFilter, StringComparison.OrdinalIgnoreCase) ||
                x.Description.Contains(trimFilter, StringComparison.OrdinalIgnoreCase)
              ).ToList();
        }
        catch
        {
            PermanentProducts = null!;
        }
    }

    private void ResetModalDisplay()
    {
        ShowProductPage = false;
        ShowConfirmationPage = false;
        ModalCustomStyle = string.Empty;
    }

    public void Dispose() => homeGenericState.StateChanged -= StateHasChanged;
}
